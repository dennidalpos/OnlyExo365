<UserControl x:Class="ExchangeAdmin.Presentation.Views.DistributionListView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">

    <Grid Margin="16">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="Auto"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

                           
        <Grid Grid.Column="0" IsEnabled="{Binding DistributionLists.IsLoading, Converter={StaticResource InverseBool}}">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

                           
            <Grid Grid.Row="0" Margin="0,0,0,16">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="Liste di distribuzione" FontSize="20" FontWeight="SemiBold"/>
                    <TextBlock Text="{Binding DistributionLists.StatusText}" Margin="12,0,0,0" VerticalAlignment="Center"
                               Foreground="{StaticResource SecondaryTextBrush}"/>
                </StackPanel>

                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <Button Content="Aggiorna" Command="{Binding DistributionLists.RefreshCommand}"
                            Style="{StaticResource PrimaryButton}"/>
                </StackPanel>
            </Grid>

                                      
            <Grid Grid.Row="1" Margin="0,0,0,12">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBox Grid.Column="0" Text="{Binding DistributionLists.SearchQuery, UpdateSourceTrigger=PropertyChanged}"
                         Margin="0,0,12,0"/>

                <CheckBox Grid.Column="1" Content="Includi dinamiche" IsChecked="{Binding DistributionLists.IncludeDynamic}"
                          VerticalAlignment="Center"/>
            </Grid>

                               
            
            <GroupBox Grid.Row="2" Header="Nuova lista di distribuzione" Margin="0,0,0,12">
                <Grid Margin="8">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <TextBox Grid.Column="0" Text="{Binding DistributionLists.NewDistributionListDisplayName, UpdateSourceTrigger=PropertyChanged}" Margin="0,0,8,0"/>
                    <TextBox Grid.Column="1" Text="{Binding DistributionLists.NewDistributionListAlias, UpdateSourceTrigger=PropertyChanged}" Margin="0,0,8,0"/>
                    <TextBox Grid.Column="2" Text="{Binding DistributionLists.NewDistributionListPrimarySmtpAddress, UpdateSourceTrigger=PropertyChanged}" Margin="0,0,8,0"/>
                    <Button Grid.Column="3" Content="Crea" Command="{Binding DistributionLists.CreateDistributionListCommand}" Style="{StaticResource PrimaryButton}"/>
                </Grid>
            </GroupBox>

            <DataGrid Grid.Row="3" ItemsSource="{Binding DistributionLists.DistributionLists}"
                      SelectedItem="{Binding DistributionLists.SelectedItem}"
                      AutoGenerateColumns="False"
                      IsReadOnly="True"
                      SelectionMode="Single"
                      CanUserAddRows="False"
                      CanUserDeleteRows="False"
                      GridLinesVisibility="Horizontal"
                      HeadersVisibility="Column"
                      Background="{StaticResource SecondaryBackgroundBrush}"
                      BorderBrush="{StaticResource BorderBrush}"
                      RowBackground="{StaticResource SecondaryBackgroundBrush}"
                      AlternatingRowBackground="{StaticResource TertiaryBackgroundBrush}"
                      VirtualizingPanel.IsVirtualizing="True"
                      VirtualizingPanel.VirtualizationMode="Recycling"
                      EnableRowVirtualization="True"
                      EnableColumnVirtualization="True"
                      ScrollViewer.IsDeferredScrollingEnabled="True">
                <DataGrid.Columns>
                    <DataGridTextColumn Header="Nome visualizzato" Binding="{Binding DisplayName}" Width="*"/>
                    <DataGridTextColumn Header="Email" Binding="{Binding PrimarySmtpAddress}" Width="*"/>
                    <DataGridTextColumn Header="Tipo" Binding="{Binding GroupType}" Width="80"/>
                    <DataGridTextColumn Header="Membri" Binding="{Binding MemberCount}" Width="60"/>
                </DataGrid.Columns>

                <DataGrid.RowStyle>
                    <Style TargetType="DataGridRow">
                        <Setter Property="Foreground" Value="{StaticResource PrimaryTextBrush}"/>
                        <Style.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter Property="Background" Value="{StaticResource AccentBrush}"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="{StaticResource TertiaryBackgroundBrush}"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </DataGrid.RowStyle>

                <DataGrid.ColumnHeaderStyle>
                    <Style TargetType="DataGridColumnHeader">
                        <Setter Property="Background" Value="{StaticResource TertiaryBackgroundBrush}"/>
                        <Setter Property="Foreground" Value="{StaticResource PrimaryTextBrush}"/>
                        <Setter Property="Padding" Value="8,6"/>
                        <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}"/>
                        <Setter Property="BorderThickness" Value="0,0,1,1"/>
                    </Style>
                </DataGrid.ColumnHeaderStyle>
            </DataGrid>

                              
            <Button Grid.Row="4" Content="Carica altri" Command="{Binding DistributionLists.LoadMoreCommand}"
                    HorizontalAlignment="Center" Margin="0,12,0,0"
                    Style="{StaticResource PrimaryButton}"
                    Visibility="{Binding DistributionLists.HasMore, Converter={StaticResource BoolToVisibility}}"/>

                                    
            <Border Background="#80000000"
                    Visibility="{Binding DistributionLists.IsLoading, Converter={StaticResource BoolToVisibility}}">
                <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                    <ProgressBar IsIndeterminate="True" Width="150" Height="4"/>
                    <TextBlock Text="Caricamento liste..." HorizontalAlignment="Center" Margin="0,8,0,0"/>
                </StackPanel>
            </Border>
        </Grid>

                         
        <GridSplitter Grid.Column="1" Width="4" Background="{StaticResource BorderBrush}"
                      HorizontalAlignment="Center" VerticalAlignment="Stretch"
                      ResizeDirection="Columns"
                      ResizeBehavior="PreviousAndNext"/>

                              
        <Grid Grid.Column="2" Margin="16,0,0,0">
            <ScrollViewer VerticalScrollBarVisibility="Auto"
                          HorizontalScrollBarVisibility="Disabled">
                <Grid>
                                         
                    <TextBlock Text="Seleziona un gruppo per vedere i dettagli"
                               HorizontalAlignment="Center" VerticalAlignment="Center"
                               Foreground="{StaticResource SecondaryTextBrush}"
                               Visibility="{Binding DistributionLists.HasDetails, Converter={StaticResource InverseBoolToVisibility}}"/>

                                            
                    <Grid Visibility="{Binding DistributionLists.HasDetails, Converter={StaticResource BoolToVisibility}}"
                          IsEnabled="{Binding DistributionLists.IsLoadingDetails, Converter={StaticResource InverseBool}}">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                                       
                        <Grid Grid.Row="0" Margin="0,0,0,16">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <StackPanel>
                                <TextBlock Text="{Binding DistributionLists.SelectedDetails.DisplayName}" FontSize="18" FontWeight="SemiBold"/>
                                <TextBlock Text="{Binding DistributionLists.SelectedDetails.PrimarySmtpAddress}"
                                           Foreground="{StaticResource SecondaryTextBrush}"/>
                            </StackPanel>

                            <Button Grid.Column="1" Content="Indietro" Command="{Binding DistributionLists.BackCommand}"/>
                        </Grid>

                                           
                        <StackPanel Grid.Row="1">
                            <Border Background="#3D2200" BorderBrush="{StaticResource WarningBrush}"
                                    BorderThickness="1" CornerRadius="4" Padding="12" Margin="0,0,0,12"
                                    Visibility="{Binding DistributionLists.HasPendingSettingsChanges, Converter={StaticResource BoolToVisibility}}">
                                <StackPanel>
                                    <TextBlock Text="âš  Modifiche non salvate" FontWeight="SemiBold"
                                               Foreground="{StaticResource WarningBrush}"/>
                                    <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                                        <Button Content="Salva" Command="{Binding DistributionLists.SaveSettingsCommand}"
                                                Style="{StaticResource PrimaryButton}" Margin="0,0,8,0"/>
                                        <Button Content="Annulla" Command="{Binding DistributionLists.DiscardSettingsCommand}"/>
                                    </StackPanel>
                                </StackPanel>
                            </Border>

                            <GroupBox Header="Informazioni gruppo" Margin="0,0,0,12">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>

                                    <TextBlock Grid.Row="0" Grid.Column="0" Text="Tipo:" Margin="0,0,12,4"
                                               Foreground="{StaticResource SecondaryTextBrush}"/>
                                    <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding DistributionLists.SelectedDetails.GroupType}"/>

                                    <TextBlock Grid.Row="1" Grid.Column="0" Text="Alias:" Margin="0,4,12,0"
                                               Foreground="{StaticResource SecondaryTextBrush}"/>
                                    <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding DistributionLists.SelectedDetails.Alias}" Margin="0,4,0,0"/>
                                </Grid>
                            </GroupBox>

                            <GroupBox Header="Proprietari" Margin="0,0,0,12">
                                <StackPanel>
                                    <ItemsControl ItemsSource="{Binding DistributionLists.SelectedDetails.ManagedBy}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding}" Margin="0,2"/>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </StackPanel>
                            </GroupBox>

                            <GroupBox Header="Indirizzi email" Margin="0,0,0,12">
                                <ItemsControl ItemsSource="{Binding DistributionLists.SelectedDetails.EmailAddresses}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding}" Foreground="{StaticResource SecondaryTextBrush}" Margin="0,2"/>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </GroupBox>

                            <GroupBox Header="Impostazioni recapito" Margin="0,0,0,12">
                                <StackPanel>
                                    <CheckBox Content="Consenti mittenti esterni"
                                              IsChecked="{Binding DistributionLists.AllowExternalSenders}"
                                              IsEnabled="{Binding DistributionLists.CanEditSettings}"
                                              ToolTip="Se disattivato, solo mittenti interni possono inviare al gruppo"/>
                                    <TextBlock Text="Questa opzione equivale a RequireSenderAuthenticationEnabled."
                                               Foreground="{StaticResource SecondaryTextBrush}" Margin="0,6,0,0"/>
                                </StackPanel>
                            </GroupBox>

                            <GroupBox Header="Filtri mittenti" Margin="0,0,0,12">
                                <StackPanel>
                                    <TextBlock Text="Accetta solo da:" FontWeight="SemiBold"/>
                                    <ItemsControl ItemsSource="{Binding DistributionLists.AcceptMessagesOnlyFrom}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Grid Margin="0,2">
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                    </Grid.ColumnDefinitions>
                                                    <TextBlock Grid.Column="0" Text="{Binding}" Margin="0,2"/>
                                                    <Button Grid.Column="1" Content="Rimuovi"
                                                            Command="{Binding DataContext.DistributionLists.RemoveAcceptSenderCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                            CommandParameter="{Binding}"
                                                            Style="{StaticResource DangerButton}" Padding="6,2"
                                                            Margin="8,0,0,0"
                                                            IsEnabled="{Binding DataContext.DistributionLists.CanEditSettings, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                                                </Grid>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>

                                    <Grid Margin="0,6,0,0"
                                          IsEnabled="{Binding DistributionLists.CanEditSettings}">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBox Grid.Column="0" Text="{Binding DistributionLists.NewAcceptedSender, UpdateSourceTrigger=PropertyChanged}"
                                                 Margin="0,0,8,0"/>
                                        <Button Grid.Column="1" Content="Aggiungi"
                                                Command="{Binding DistributionLists.AddAcceptSenderCommand}"
                                                Style="{StaticResource PrimaryButton}"/>
                                    </Grid>

                                    <TextBlock Text="Rifiuta da:" FontWeight="SemiBold" Margin="0,8,0,0"/>
                                    <ItemsControl ItemsSource="{Binding DistributionLists.RejectMessagesFrom}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Grid Margin="0,2">
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                    </Grid.ColumnDefinitions>
                                                    <TextBlock Grid.Column="0" Text="{Binding}" Margin="0,2"/>
                                                    <Button Grid.Column="1" Content="Rimuovi"
                                                            Command="{Binding DataContext.DistributionLists.RemoveRejectSenderCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                            CommandParameter="{Binding}"
                                                            Style="{StaticResource DangerButton}" Padding="6,2"
                                                            Margin="8,0,0,0"
                                                            IsEnabled="{Binding DataContext.DistributionLists.CanEditSettings, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                                                </Grid>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>

                                    <Grid Margin="0,6,0,0"
                                          IsEnabled="{Binding DistributionLists.CanEditSettings}">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBox Grid.Column="0" Text="{Binding DistributionLists.NewRejectedSender, UpdateSourceTrigger=PropertyChanged}"
                                                 Margin="0,0,8,0"/>
                                        <Button Grid.Column="1" Content="Aggiungi"
                                                Command="{Binding DistributionLists.AddRejectSenderCommand}"
                                                Style="{StaticResource PrimaryButton}"/>
                                    </Grid>
                                </StackPanel>
                            </GroupBox>
                        </StackPanel>

                                        
                        <GroupBox Grid.Row="2" Header="Membri">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>

                                                              
                                <Border Grid.Row="0" Background="#3D2200" BorderBrush="{StaticResource WarningBrush}"
                                        BorderThickness="1" CornerRadius="4" Padding="8" Margin="0,0,0,8"
                                        Visibility="{Binding DistributionLists.IsDynamicGroup, Converter={StaticResource BoolToVisibility}}">
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="Gruppo dinamico: i membri sono calcolati dal filtro."
                                                   Foreground="{StaticResource WarningBrush}"/>
                                        <Button Content="Anteprima membri" Command="{Binding DistributionLists.PreviewDynamicMembersCommand}"
                                                Margin="12,0,0,0" Padding="8,2"/>
                                    </StackPanel>
                                </Border>

                                                     
                                <ListBox Grid.Row="1" ItemsSource="{Binding DistributionLists.Members}"
                                         Background="{StaticResource SecondaryBackgroundBrush}"
                                         BorderBrush="{StaticResource BorderBrush}">
                                    <ListBox.ItemTemplate>
                                        <DataTemplate>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>

                                                <StackPanel Grid.Column="0">
                                                    <TextBlock Text="{Binding Name}"/>
                                                    <TextBlock Text="{Binding PrimarySmtpAddress}" FontSize="11"
                                                               Foreground="{StaticResource SecondaryTextBrush}"/>
                                                </StackPanel>

                                                <Button Grid.Column="1" Content="Rimuovi"
                                                        Command="{Binding DataContext.DistributionLists.RemoveMemberCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                        CommandParameter="{Binding}"
                                                        Style="{StaticResource DangerButton}" Padding="6,2"
                                                        Visibility="{Binding DataContext.DistributionLists.CanModifyMembers, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource BoolToVisibility}}"/>
                                            </Grid>
                                        </DataTemplate>
                                    </ListBox.ItemTemplate>
                                </ListBox>

                                                   
                                <Grid Grid.Row="2" Margin="0,8,0,0"
                                      Visibility="{Binding DistributionLists.CanModifyMembers, Converter={StaticResource BoolToVisibility}}">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>

                                    <TextBox Grid.Column="0" Text="{Binding DistributionLists.NewMemberIdentity, UpdateSourceTrigger=PropertyChanged}"
                                             Margin="0,0,8,0"/>
                                    <Button Grid.Column="1" Content="Aggiungi membro" Command="{Binding DistributionLists.AddMemberCommand}"
                                            Style="{StaticResource PrimaryButton}"/>
                                </Grid>
                            </Grid>
                        </GroupBox>

                                                  
                        <Button Grid.Row="3" Content="Carica altri membri" Command="{Binding DistributionLists.LoadMoreMembersCommand}"
                                HorizontalAlignment="Center" Margin="0,8,0,0"
                                Visibility="{Binding DistributionLists.MembersHasMore, Converter={StaticResource BoolToVisibility}}"/>
                    </Grid>
                </Grid>
            </ScrollViewer>

                                    
            <Border Background="#80000000"
                    Visibility="{Binding DistributionLists.IsLoadingDetails, Converter={StaticResource BoolToVisibility}}">
                <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                    <ProgressBar IsIndeterminate="True" Width="150" Height="4"/>
                    <TextBlock Text="Caricamento dettagli..." HorizontalAlignment="Center" Margin="0,8,0,0"/>
                </StackPanel>
            </Border>
        </Grid>
    </Grid>
</UserControl>
