<UserControl x:Class="ExchangeAdmin.Presentation.Views.ToolsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">

    <Grid Margin="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <TextBlock Grid.Row="0" Text="Tools" FontSize="20" FontWeight="SemiBold" Margin="0,0,0,16"/>

        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
            <StackPanel>
                <TextBlock Margin="0,0,0,8"
                           Foreground="{StaticResource WarningBrush}"
                           TextWrapping="Wrap"
                           Visibility="{Binding IsExchangeConnectionDisabled, Converter={StaticResource BoolToVisibility}}"
                           Text="Exchange Online connections are disabled by policy (EXCHANGEADMIN_DISABLE_EXO=1)."/>

                <!-- Connection Information -->
                <GroupBox Header="Connection Information">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <TextBlock Grid.Row="0" Grid.Column="0" Text="Status:" Margin="0,0,12,4"
                                   Foreground="{StaticResource SecondaryTextBrush}"/>
                        <TextBlock Grid.Row="0" Grid.Column="1">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock" BasedOn="{StaticResource {x:Type TextBlock}}">
                                    <Setter Property="Text" Value="Disconnected"/>
                                    <Setter Property="Foreground" Value="{StaticResource SecondaryTextBrush}"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsExchangeConnected}" Value="True">
                                            <Setter Property="Text" Value="Connected"/>
                                            <Setter Property="Foreground" Value="{StaticResource SuccessBrush}"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>

                        <TextBlock Grid.Row="1" Grid.Column="0" Text="User:" Margin="0,4,12,4"
                                   Foreground="{StaticResource SecondaryTextBrush}"/>
                        <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding ConnectedUser, FallbackValue='-'}" Margin="0,4,0,4"/>

                        <TextBlock Grid.Row="2" Grid.Column="0" Text="Organization:" Margin="0,4,12,4"
                                   Foreground="{StaticResource SecondaryTextBrush}"/>
                        <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding ConnectedOrganization, FallbackValue='-'}" Margin="0,4,0,4"/>

                        <TextBlock Grid.Row="3" Grid.Column="0" Text="Capabilities:" Margin="0,4,12,0"
                                   Foreground="{StaticResource SecondaryTextBrush}"/>
                        <TextBlock Grid.Row="3" Grid.Column="1" Margin="0,4,0,0">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock" BasedOn="{StaticResource {x:Type TextBlock}}">
                                    <Setter Property="Text" Value="Not detected"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding HasCapabilities}" Value="True">
                                            <Setter Property="Text">
                                                <Setter.Value>
                                                    <Binding Path="Capabilities.Cmdlets.Count" StringFormat="{}{0} cmdlets detected"/>
                                                </Setter.Value>
                                            </Setter>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                    </Grid>
                </GroupBox>

                <!-- Worker Status -->
                <GroupBox Header="Worker Status" Margin="0,8,0,0">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <TextBlock Grid.Row="0" Grid.Column="0" Text="Worker State:" Margin="0,0,12,4"
                                   Foreground="{StaticResource SecondaryTextBrush}"/>
                        <StackPanel Grid.Row="0" Grid.Column="1" Orientation="Horizontal">
                            <Ellipse Width="10" Height="10" VerticalAlignment="Center" Margin="0,0,8,0">
                                <Ellipse.Fill>
                                    <SolidColorBrush Color="{Binding WorkerStateColor}"/>
                                </Ellipse.Fill>
                            </Ellipse>
                            <TextBlock Text="{Binding WorkerStateDisplay}"/>
                        </StackPanel>

                        <TextBlock Grid.Row="1" Grid.Column="0" Text="Worker Running:" Margin="0,4,12,0"
                                   Foreground="{StaticResource SecondaryTextBrush}"/>
                        <TextBlock Grid.Row="1" Grid.Column="1" Margin="0,4,0,0">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock" BasedOn="{StaticResource {x:Type TextBlock}}">
                                    <Setter Property="Text" Value="No"/>
                                    <Setter Property="Foreground" Value="{StaticResource ErrorBrush}"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsWorkerRunning}" Value="True">
                                            <Setter Property="Text" Value="Yes"/>
                                            <Setter Property="Foreground" Value="{StaticResource SuccessBrush}"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                    </Grid>
                </GroupBox>

                <!-- Quick Actions -->
                <GroupBox Header="Quick Actions" Margin="0,8,0,0">
                    <StackPanel Orientation="Horizontal">
                        <Button Content="Start Worker" Command="{Binding StartWorkerCommand}"
                                Style="{StaticResource PrimaryButton}"/>
                        <Button Content="Restart Worker" Command="{Binding RestartWorkerCommand}"/>
                        <Button Content="Connect Exchange" Command="{Binding ConnectExchangeCommand}"
                                Style="{StaticResource PrimaryButton}"/>
                        <Button Content="Disconnect" Command="{Binding DisconnectExchangeCommand}"/>
                    </StackPanel>
                </GroupBox>

                <!-- Module Management -->
                <GroupBox Header="Gestione Moduli" Margin="0,8,0,0">
                    <StackPanel>
                        <!-- Progress bar for checking/installing -->
                        <StackPanel Margin="0,0,0,8"
                                    Visibility="{Binding Tools.IsChecking, Converter={StaticResource BoolToVisibility}}">
                            <ProgressBar Minimum="0" Maximum="100" Value="{Binding Tools.InstallProgress, Mode=OneWay}"
                                         Height="4" Foreground="{StaticResource AccentBrush}"
                                         Background="{StaticResource TertiaryBackgroundBrush}"/>
                            <TextBlock Text="{Binding Tools.InstallStatus}" HorizontalAlignment="Center" Margin="0,4,0,0"
                                       Foreground="{StaticResource SecondaryTextBrush}" FontSize="11"/>
                        </StackPanel>
                        <StackPanel Margin="0,0,0,8"
                                    Visibility="{Binding Tools.IsInstalling, Converter={StaticResource BoolToVisibility}}">
                            <ProgressBar Minimum="0" Maximum="100" Value="{Binding Tools.InstallProgress, Mode=OneWay}"
                                         Height="4" Foreground="{StaticResource AccentBrush}"
                                         Background="{StaticResource TertiaryBackgroundBrush}"/>
                            <TextBlock Text="{Binding Tools.InstallStatus}" HorizontalAlignment="Center" Margin="0,4,0,0"
                                       Foreground="{StaticResource SecondaryTextBrush}" FontSize="11"/>
                        </StackPanel>

                        <!-- Error message -->
                        <Border Background="#3D0000" BorderBrush="{StaticResource ErrorBrush}"
                                BorderThickness="1" CornerRadius="4" Padding="8" Margin="0,0,0,8"
                                Visibility="{Binding Tools.HasError, Converter={StaticResource BoolToVisibility}}">
                            <TextBlock Text="{Binding Tools.ErrorMessage}" TextWrapping="Wrap"
                                       Foreground="{StaticResource ErrorBrush}" FontSize="11"/>
                        </Border>

                        <Button Content="Verifica Prerequisiti" Command="{Binding Tools.CheckPrerequisitesCommand}"
                                Style="{StaticResource PrimaryButton}" HorizontalAlignment="Left" Margin="0,0,0,12"/>

                        <Border Background="{StaticResource SecondaryBackgroundBrush}" BorderBrush="{StaticResource BorderBrush}" BorderThickness="1" CornerRadius="4" Padding="8" Margin="0,0,0,8"
                                Visibility="{Binding Tools.HasChecked, Converter={StaticResource BoolToVisibility}}">
                            <StackPanel>
                                <TextBlock Text="{Binding Tools.PrerequisiteSummary}" TextWrapping="Wrap" FontWeight="SemiBold"/>
                                <TextBlock Text="{Binding Tools.SuggestedActions}" TextWrapping="Wrap" Margin="0,4,0,0" Foreground="{StaticResource SecondaryTextBrush}"/>
                            </StackPanel>
                        </Border>

                        <!-- PowerShell 7 -->
                        <Grid Margin="0,0,0,8" Visibility="{Binding Tools.HasChecked, Converter={StaticResource BoolToVisibility}}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Ellipse Grid.Column="0" Width="10" Height="10" VerticalAlignment="Center" Margin="0,0,8,0">
                                <Ellipse.Style>
                                    <Style TargetType="Ellipse">
                                        <Setter Property="Fill" Value="{StaticResource ErrorBrush}"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding Tools.IsPowerShell7}" Value="True">
                                                <Setter Property="Fill" Value="{StaticResource SuccessBrush}"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Ellipse.Style>
                            </Ellipse>
                            <TextBlock Grid.Column="1" VerticalAlignment="Center">
                                <Run Text="PowerShell 7 "/>
                                <Run Text="{Binding Tools.PowerShellVersion, Mode=OneWay, FallbackValue=''}"
                                     Foreground="{StaticResource SecondaryTextBrush}"/>
                            </TextBlock>
                            <Button Grid.Column="2" Content="Installa" Command="{Binding Tools.InstallPowerShellCommand}"
                                    Margin="8,0,0,0" Padding="12,4"/>
                            <Button Grid.Column="3" Content="GitHub" Command="{Binding Tools.OpenPowerShellGitHubCommand}"
                                    Margin="4,0,0,0" Padding="12,4"/>
                        </Grid>

                        <!-- ExchangeOnlineManagement -->
                        <Grid Margin="0,0,0,8" Visibility="{Binding Tools.HasChecked, Converter={StaticResource BoolToVisibility}}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Ellipse Grid.Column="0" Width="10" Height="10" VerticalAlignment="Center" Margin="0,0,8,0">
                                <Ellipse.Style>
                                    <Style TargetType="Ellipse">
                                        <Setter Property="Fill" Value="{StaticResource ErrorBrush}"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding Tools.ExchangeModuleInstalled}" Value="True">
                                                <Setter Property="Fill" Value="{StaticResource SuccessBrush}"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Ellipse.Style>
                            </Ellipse>
                            <TextBlock Grid.Column="1" VerticalAlignment="Center">
                                <Run Text="ExchangeOnlineManagement "/>
                                <Run Text="{Binding Tools.ExchangeModuleVersion, Mode=OneWay, FallbackValue=''}"
                                     Foreground="{StaticResource SecondaryTextBrush}"/>
                            </TextBlock>
                            <Button Grid.Column="2" Content="Installa" Command="{Binding Tools.InstallExchangeModuleCommand}"
                                    Margin="8,0,0,0" Padding="12,4"/>
                        </Grid>

                        <!-- Microsoft.Graph -->
                        <Grid Margin="0,0,0,0" Visibility="{Binding Tools.HasChecked, Converter={StaticResource BoolToVisibility}}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Ellipse Grid.Column="0" Width="10" Height="10" VerticalAlignment="Center" Margin="0,0,8,0">
                                <Ellipse.Style>
                                    <Style TargetType="Ellipse">
                                        <Setter Property="Fill" Value="{StaticResource ErrorBrush}"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding Tools.GraphModuleInstalled}" Value="True">
                                                <Setter Property="Fill" Value="{StaticResource SuccessBrush}"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Ellipse.Style>
                            </Ellipse>
                            <TextBlock Grid.Column="1" VerticalAlignment="Center">
                                <Run Text="Microsoft.Graph.Authentication "/>
                                <Run Text="{Binding Tools.GraphModuleVersion, Mode=OneWay, FallbackValue=''}"
                                     Foreground="{StaticResource SecondaryTextBrush}"/>
                            </TextBlock>
                            <Button Grid.Column="2" Content="Installa" Command="{Binding Tools.InstallGraphModuleCommand}"
                                    Margin="8,0,0,0" Padding="12,4"/>
                        </Grid>
                    </StackPanel>
                </GroupBox>
            </StackPanel>
        </ScrollViewer>
    </Grid>
</UserControl>
